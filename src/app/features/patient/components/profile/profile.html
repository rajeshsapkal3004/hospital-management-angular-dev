<div class="profile-container">
  <!-- Header -->
  <div class="profile-header">
    <div class="header-content">
      <div class="profile-avatar">
        <mat-icon aria-hidden="false">person</mat-icon>
      </div>
      <div class="header-info">
        <h1 class="profile-name">{{ currentUser?.firstName }} {{ currentUser?.lastName }}</h1>
        <p class="profile-subtitle" *ngIf="currentPatient">
          Patient ID: {{ currentPatient.patientId }}
          <span *ngIf="calculateAge()" class="age-info">â€¢ Age: {{ calculateAge() }} years</span>
        </p>
      </div>
    </div>
    <div class="header-actions">
      <button 
        mat-raised-button 
        [color]="isEditing ? 'warn' : 'primary'"
        (click)="toggleEdit()"
        [disabled]="isSaving">
        <mat-icon aria-hidden="false"  >{{ isEditing ? 'cancel' : 'edit' }}</mat-icon>
        {{ isEditing ? 'Cancel' : 'Edit Profile' }}
      </button>
      
      <button 
        *ngIf="isEditing"
        mat-raised-button 
        color="primary"
        (click)="saveProfile()"
        [disabled]="isSaving">
        <mat-spinner *ngIf="isSaving" diameter="20" class="inline-spinner"></mat-spinner>
        <mat-icon *ngIf="!isSaving" aria-hidden="false">save</mat-icon>
        {{ isSaving ? 'Saving...' : 'Save Changes' }}
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Loading your profile...</p>
  </div>

  <!-- Profile Content -->
  <div class="profile-content" *ngIf="!isLoading">
    <mat-tab-group class="profile-tabs">
      
      <!-- Personal Information Tab -->
      <mat-tab label="Personal Information">
        <div class="tab-content">
          <form [formGroup]="profileForm" class="profile-form">
            
            <!-- Basic Information Section -->
            <mat-card class="info-section">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon aria-hidden="false">person</mat-icon>
                  Basic Information
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="form-grid">
                  <mat-form-field appearance="fill">
                    <mat-label>First Name</mat-label>
                    <input matInput formControlName="firstName" [readonly]="!isEditing">
                    <mat-error *ngIf="profileForm.get('firstName')?.invalid && profileForm.get('firstName')?.touched">
                      {{ getErrorMessage(profileForm, 'firstName') }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>Last Name</mat-label>
                    <input matInput formControlName="lastName" [readonly]="!isEditing">
                    <mat-error *ngIf="profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched">
                      {{ getErrorMessage(profileForm, 'lastName') }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>Email</mat-label>
                    <input matInput formControlName="email" type="email" [readonly]="!isEditing">
                    <mat-icon matPrefix aria-hidden="false">email</mat-icon>
                    <mat-error *ngIf="profileForm.get('email')?.invalid && profileForm.get('email')?.touched">
                      {{ getErrorMessage(profileForm, 'email') }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>Phone</mat-label>
                    <input matInput formControlName="phone" [readonly]="!isEditing">
                    <mat-icon matPrefix aria-hidden="false">phone</mat-icon>
                    <mat-error *ngIf="profileForm.get('phone')?.invalid && profileForm.get('phone')?.touched">
                      {{ getErrorMessage(profileForm, 'phone') }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>Date of Birth</mat-label>
                    <input matInput [matDatepicker]="dobPicker" formControlName="dateOfBirth" [readonly]="!isEditing">
                    <mat-datepicker-toggle matSuffix [for]="dobPicker" [disabled]="!isEditing"></mat-datepicker-toggle>
                    <mat-datepicker #dobPicker [disabled]="!isEditing"></mat-datepicker>
                    <mat-error *ngIf="profileForm.get('dateOfBirth')?.invalid && profileForm.get('dateOfBirth')?.touched">
                      {{ getErrorMessage(profileForm, 'dateOfBirth') }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>Gender</mat-label>
                    <mat-select formControlName="gender" [disabled]="!isEditing">
                      <mat-option *ngFor="let gender of genders" [value]="gender">
                        {{ gender | titlecase }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Medical Information Section -->
            <mat-card class="info-section">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon aria-hidden="false">medical_services</mat-icon>
                  Medical Information
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="form-grid">
                  <mat-form-field appearance="fill">
                    <mat-label>Blood Type</mat-label>
                    <mat-select formControlName="bloodType" [disabled]="!isEditing">
                      <mat-option *ngFor="let bloodType of bloodTypes" [value]="bloodType">
                        {{ bloodType }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>Height (cm)</mat-label>
                    <input matInput formControlName="height" type="number" [readonly]="!isEditing">
                    <mat-error *ngIf="profileForm.get('height')?.invalid && profileForm.get('height')?.touched">
                      {{ getErrorMessage(profileForm, 'height') }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>Weight (kg)</mat-label>
                    <input matInput formControlName="weight" type="number" [readonly]="!isEditing">
                    <mat-error *ngIf="profileForm.get('weight')?.invalid && profileForm.get('weight')?.touched">
                      {{ getErrorMessage(profileForm, 'weight') }}
                    </mat-error>
                  </mat-form-field>

                  <!-- BMI Display -->
                  <div class="bmi-display" *ngIf="calculateBMI()">
                    <div class="bmi-info">
                      <span class="bmi-label">BMI:</span>
                      <span class="bmi-value">{{ calculateBMI() }}</span>
                      <mat-chip class="bmi-category" [class.normal]="getBMICategory() === 'Normal'">
                        {{ getBMICategory() }}
                      </mat-chip>
                    </div>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Address Information Section -->
            <mat-card class="info-section">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon aria-hidden="false">home</mat-icon>
                  Address Information
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="form-grid">
                  <mat-form-field appearance="fill" class="full-width">
                    <mat-label>Address</mat-label>
                    <input matInput formControlName="address" [readonly]="!isEditing">
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>City</mat-label>
                    <input matInput formControlName="city" [readonly]="!isEditing">
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>State</mat-label>
                    <input matInput formControlName="state" [readonly]="!isEditing">
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>Country</mat-label>
                    <input matInput formControlName="country" [readonly]="!isEditing">
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>Postal Code</mat-label>
                    <input matInput formControlName="postalCode" [readonly]="!isEditing">
                  </mat-form-field>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Additional Information Section -->
            <mat-card class="info-section">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon aria-hidden="false">info</mat-icon>
                  Additional Information
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="form-grid">
                  <mat-form-field appearance="fill">
                    <mat-label>Occupation</mat-label>
                    <input matInput formControlName="occupation" [readonly]="!isEditing">
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>Marital Status</mat-label>
                    <mat-select formControlName="maritalStatus" [disabled]="!isEditing">
                      <mat-option *ngFor="let status of maritalStatuses" [value]="status">
                        {{ status | titlecase }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Insurance Information Section -->
            <mat-card class="info-section">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon aria-hidden="false">security</mat-icon>
                  Insurance Information
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="form-grid">
                  <mat-form-field appearance="fill">
                    <mat-label>Insurance Provider</mat-label>
                    <input matInput formControlName="insuranceProvider" [readonly]="!isEditing">
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>Insurance Number</mat-label>
                    <input matInput formControlName="insuranceNumber" [readonly]="!isEditing">
                  </mat-form-field>
                </div>
              </mat-card-content>
            </mat-card>
          </form>
        </div>
      </mat-tab>

      <!-- Emergency Contact Tab -->
      <mat-tab label="Emergency Contact">
        <div class="tab-content">
          <form [formGroup]="emergencyContactForm" class="profile-form">
            <mat-card class="info-section">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon aria-hidden="false">contact_emergency</mat-icon>
                  Emergency Contact Information
                </mat-card-title>
                <mat-card-subtitle>
                  This person will be contacted in case of emergency
                </mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="form-grid">
                  <mat-form-field appearance="fill">
                    <mat-label>Contact Name</mat-label>
                    <input matInput formControlName="emergencyContactName" [readonly]="!isEditing">
                    <mat-icon matPrefix aria-hidden="false">person</mat-icon>
                    <mat-error *ngIf="emergencyContactForm.get('emergencyContactName')?.invalid && emergencyContactForm.get('emergencyContactName')?.touched">
                      {{ getErrorMessage(emergencyContactForm, 'emergencyContactName') }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>Contact Phone</mat-label>
                    <input matInput formControlName="emergencyContactPhone" [readonly]="!isEditing">
                    <mat-icon matPrefix aria-hidden="false">phone</mat-icon>
                    <mat-error *ngIf="emergencyContactForm.get('emergencyContactPhone')?.invalid && emergencyContactForm.get('emergencyContactPhone')?.touched">
                      {{ getErrorMessage(emergencyContactForm, 'emergencyContactPhone') }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="fill">
                    <mat-label>Relationship</mat-label>
                    <input matInput formControlName="emergencyContactRelationship" [readonly]="!isEditing" 
                           placeholder="e.g., Spouse, Parent, Sibling">
                    <mat-icon matPrefix aria-hidden="false">family_restroom</mat-icon>
                  </mat-form-field>
                </div>
              </mat-card-content>
            </mat-card>
          </form>
        </div>
      </mat-tab>

      <!-- Medical History Tab -->
      <mat-tab label="Medical History">
        <div class="tab-content">
          <form [formGroup]="medicalInfoForm" class="profile-form">
            
            <!-- Allergies Section -->
            <mat-card class="info-section">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon aria-hidden="false">warning</mat-icon>
                  Allergies
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="array-section">
                  <div class="array-items" *ngIf="allergies.length > 0">
                    <div *ngFor="let item of allergies.controls; let i = index" class="array-item">
                      <mat-form-field appearance="fill" class="array-field">
                        <mat-label>Allergy {{ i + 1 }}</mat-label>
                        <input matInput [formControlName]="i" [readonly]="!isEditing">
                      </mat-form-field>
                      <button 
                        *ngIf="isEditing"
                        mat-icon-button 
                        type="button" 
                        color="warn"
                        (click)="removeItem('allergies', i)">
                        <mat-icon aria-hidden="false"> remove_circle</mat-icon>
                      </button>
                    </div>
                  </div>
                  <button 
                    *ngIf="isEditing"
                    mat-button 
                    type="button" 
                    color="primary"
                    (click)="addItem('allergies')" 
                    class="add-button">
                    <mat-icon aria-hidden="false">add</mat-icon>
                    Add Allergy
                  </button>
                  <div *ngIf="!isEditing && allergies.length === 0" class="empty-message">
                    No allergies recorded
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Medical Conditions Section -->
            <mat-card class="info-section">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon aria-hidden="false">medical_information</mat-icon>
                  Medical Conditions
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="array-section">
                  <div class="array-items" *ngIf="medicalConditions.length > 0">
                    <div *ngFor="let item of medicalConditions.controls; let i = index" class="array-item">
                      <mat-form-field appearance="fill" class="array-field">
                        <mat-label>Condition {{ i + 1 }}</mat-label>
                        <input matInput [formControlName]="i" [readonly]="!isEditing">
                      </mat-form-field>
                      <button 
                        *ngIf="isEditing"
                        mat-icon-button 
                        type="button" 
                        color="warn"
                        (click)="removeItem('medicalConditions', i)">
                        <mat-icon aria-hidden="false">remove_circle</mat-icon>
                      </button>
                    </div>
                  </div>
                  <button 
                    *ngIf="isEditing"
                    mat-button 
                    type="button" 
                    color="primary"
                    (click)="addItem('medicalConditions')" 
                    class="add-button">
                    <mat-icon aria-hidden="false">add</mat-icon>
                    Add Medical Condition
                  </button>
                  <div *ngIf="!isEditing && medicalConditions.length === 0" class="empty-message">
                    No medical conditions recorded
                  </div>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Current Medications Section -->
            <mat-card class="info-section">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon aria-hidden="false">medication</mat-icon>
                  Current Medications
                </mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="array-section">
                  <div class="array-items" *ngIf="currentMedications.length > 0">
                    <div *ngFor="let item of currentMedications.controls; let i = index" class="array-item">
                      <mat-form-field appearance="fill" class="array-field">
                        <mat-label>Medication {{ i + 1 }}</mat-label>
                        <input matInput [formControlName]="i" [readonly]="!isEditing">
                      </mat-form-field>
                      <button 
                        *ngIf="isEditing"
                        mat-icon-button 
                        type="button" 
                        color="warn"
                        (click)="removeItem('currentMedications', i)">
                        <mat-icon aria-hidden="false">remove_circle</mat-icon>
                      </button>
                    </div>
                  </div>
                  <button 
                    *ngIf="isEditing"
                    mat-button 
                    type="button" 
                    color="primary"
                    (click)="addItem('currentMedications')" 
                    class="add-button">
                    <mat-icon aria-hidden="false">add</mat-icon>
                    Add Medication
                  </button>
                  <div *ngIf="!isEditing && currentMedications.length === 0" class="empty-message">
                    No current medications recorded
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </form>
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>
